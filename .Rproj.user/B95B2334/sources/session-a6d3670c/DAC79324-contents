#Output
output_folder <- here(results_output)
if (!dir.exists(output_folder)) {
  dir.create(output_folder)
}


#Instantiate cohorts for characterisation
#source(here("1_InstantiateConcepts", "inst.R"))

#Create denominator
cdm <- generateDenominatorCohortSet(cdm=cdm,
                                    name = "denominator",
                                    cohortDateRange = as.Date(c("2019-01-01", "2019-12-31")),
                                    ageGroup = list(c(0, 150)),
                                    sex = "Both",
                                    daysPriorObservation = c(0,prior_obs),
                                    requirementInteractions = FALSE)


# Characterisation of pop. excluded (ref: denominator with daysPriorObservation=0)
excluded<-list()      

for (i in prior_obs){
  id <- settings(cdm$denominator)%>%
    filter(days_prior_observation==i)%>%
    select(cohort_definition_id)%>%
    pull()
  noObs_id <- settings(cdm$denominator)%>%
    filter(days_prior_observation=="0")%>%
    select(cohort_definition_id)%>%
    pull()
  excluded[[paste0(i,"_days")]] <-cdm$denominator %>%
    filter(cohort_definition_id==noObs_id) %>%
    anti_join(cdm$denominator %>%
                filter(cohort_definition_id==id))%>%
    summariseCharacteristics(
      tableIntersectCount = list(
          "Conditions during prior history" = list(
             tableName = "condition_occurrence",
            window = c(-Inf, -1)
          ),
        "Drug exposures during prior history" = list(
          tableName = "drug_exposure",
          window = c(-Inf, -1)
        ),
        "Visits during prior history" = list(
          tableName = "visit_occurrence",
          window = c(-Inf, -1)
        ),
        "Procedures during prior history" = list(
          tableName = "procedure_occurrence",
          window = c(-Inf, -1)
        )
      ) 
    ) %>%
    mutate(group_level=paste0(i, " days of prior observation"))
}

resultsExcluded<-bind_rows(excluded)
tableExcluded<-tableCharacteristics(resultsExcluded)

##Export
write.csv(tableExcluded, file = here(output_folder, paste0("Characteristics_", cdmName(cdm), ".csv")))

toPlot <- c("Conditions during prior history", "Drug exposures during prior history", 
            "Visits during prior history", "Procedures during prior history")
walk(toPlot, ~ plot_priorRecords(data = resultsExcluded, variable = .x))
